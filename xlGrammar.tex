
\documentclass[conference]{IEEEtran}

%\usepackage{cite}

% correct bad hyphenation here
\hyphenation{}

\usepackage{booktabs}

% Syntax package configuration
\usepackage[rounded]{syntax}
\setlength{\grammarparsep}{4pt plus 1pt minus 1pt}

\begin{document}

\title{A LALR(1) Grammar for Excel Formulas}

\maketitle


\begin{abstract}

The abstract goes here.
\end{abstract}

\IEEEpeerreviewmaketitle


\section{Introduction}

spreadsheets as programming:
- cell calculation chains as lines of code - size, example
- avg lines of code per spreadsheet in the enron dataset

motivation: why we need a defined grammar
- parsing spreadsheet formulas, analysis, extracting metrics, finding smells, exploring the structure of spreadsheets
- refer to papers needing/referring to a simple grammar
- benefit of a simple grammar and documentation for spreadsheet users
- to explore/uncover smelly syntactical constructs that are within the grammar coverage

challenges:
- official grammar for Excel not defined. Only through datasets analysis can we discover all the possible ways eg to 
express a reference, partly because excel is very forgiving
- grammar changes with different Excel versions, eg regular expressions support, labels in formulas now expanded to cell
references, updates in the built-in functions list

our approach:
development of grammar starting from previous work (reference to simple grammar) and analyzing the two datasets, enriching the
grammar to support everything

\section{Spreadsheet Formula Grammar}

All strings and characters are case-insensitive, unless otherwise noted.

\subsection{Lexical analysis}

Table \ref{table:tokens} contains an overview of the tokens produced by the scanner in our parser. The rules are given in a very simple regular expression language, but could be easily adapted for a scanner which does not support regular expression tokens.

Our tokens also require the scanner to support token priorities. Removing the necessity for token priorities is possible by altering the tokens and production rules, but makes the grammar more complicated and the resulting tree harder to use. Leaving the tokens as-is but not providing priorities will still result in a usable grammar, but expect errors on edge cases.

\begin{table*}
\label{table:tokens}
\caption{Lexical tokens used in our grammar}
\begin{tabular}{@{}lllll@{}}
\toprule
Token Name             & Description                                                                                                             & Rule                                                                                                                                                                                              & Priority & Example            \\ \midrule
BINOP                  & Binary Operator                                                                                                         & + $\mid$ - $\mid$ / $\mid$ * $\mid$ \textasciicircum $\mid$ \textless $\mid$ \textgreater $\mid$ = $\mid$ \textless= $\mid$ \textgreater= $\mid$ \textless \textgreater       & 0        & +                  \\
BOOL                   & Boolean literal                                                                                                         & "TRUE" $\mid$ "FALSE"                                                                                                                                                                                  & 0        & TRUE               \\
CELL                   & Cell reference                                                                                                          & "$"? [A-Z]+ "$"? {[}0-9{]}+                                                                                                                                                                       & 2        & $A$1               \\
ERROR                  & Error literal                                                                                                           & \begin{tabular}[c]{@{}l@{}}"\#NULL!" $\mid$ "\#DIV/0!" $\mid$ "\#VALUE!" $\mid$\\   "\#REF!" $\mid$ "\#NAME?" $\mid$ "\#NUM!" $\mid$ "\#N/A"\end{tabular}                                                                       & 0        & \#REF!             \\
FILE                   & External file reference                                                                                                 & "{[}" {[}0-9{]}+ "{]}"                                                                                                                                                                            & 5        & {[}1{]}            \\
FUNCTION               & Excel built-in function                                                                                                 & (Any entry from Appendix X) "("                                                                                                                                                                   & 5        & SUM(               \\
HORIZONTAL\_RANGE      & Range of rows                                                                                                           & "$"? [0-9]+ ":" "$"? {[}0-9{]}+                                                                                                                                                                   & 0        & 1:4                \\
MULTIPLE\_SHEETS       & Multiple sheet references                                                                                               &
[a-zA-Z0-9]+ ":" ([0-9A-Z\_.]+ $\mid$ "'" ([0-9A-Z\_ !@\#\$\%\textasciicircum{}\&*()\-+=\{\}:;$\mid$\textless\textgreater,./?\textbackslash{}\textbackslash{}] $\mid$ `''')+  `\ '\ ') `!'
& 1        & Sheet1:Sheet5!     \\
NAMED\_RANGE           & Named range                                                                                                             & {[}A-Z\_{]}{[}A-Za-z0-9\_.{]}*                                                                                                                                                                    & -2       & MYNAME             \\
NAMED\_RANGE\_PREFIXED & \begin{tabular}[c]{l} Named range which starts \\ with a string  that could be another token \end{tabular} & \begin{tabular}[c]{@{}l@{}}("TRUE" $\mid$ "FALSE" $\mid$ {[}A-Z{]}+{[}0-9{]}+)\\   {[}A-Z\_{]}{[}A-Za-z0-9\_.{]}*\end{tabular}                                                                              & 3        & A1MYNAME           \\
NUMBER\_LITERAL        & \begin{tabular}[c]{@{}l@{}}A integer, floating point\\     or scientific notation number literal\end{tabular}           & {[}0-9{]}+ ","? {[}0-9{]}* ("e" {[}0-9{]}+)?                                                                                                                                                      & 0        & 10.1               \\
QUOTED\_FILE\_SHEET    & A file reference within single quotes                                                                                   & 
"'[" [0-9]+ "]" ([0-9A-Z\_ !@\#\$\%\textasciicircum{}\&*()\-+=\{\}:;$\mid$\textless\textgreater,./?\textbackslash{}\textbackslash{}] $\mid$ `''')+ "'!"
& 5        & '{[}1{]}My Sheet'! \\
REFERENCE\_FUNCTION    & Excel built-in reference function                                                                                       & \begin{tabular}[c]{@{}l@{}}(`INDEX' $\mid$ `OFFSET' $\mid$ `INDIRECT')    `('\end{tabular}                                                                                                                 & 5        & INDEX(             \\
RESERVED\_NAME         & An Excel reserved name                                                                                                  & `\_xlnm.'  [A-Z\_]+                                                                                                                                                                            & -1       & \_xlnm.History     \\
SHEET                  & The name of another worksheet                                                                                           &                      & 5        & Sheet1!            \\
STRING                 & String literal                                                                                                          & ` " ' ([\textasciicircum{} "] $\mid$ ` "" ')*   ` " '                                                                                                     & 0        & "He Said: ""Hi"""  \\
UNOP\_PREFIX           & Unary postfix operator                                                                                                  & `\%'                                                                                                                                                                                                & 0        & \%                 \\
UNOP\_POSTFIX          & Unary prefix operator                                                                                                   & `+' $\mid$ `-'                                                                                                                                                                                         & 0        & -                  \\
UDF                    & User Defined Function                                                                                                   & `\_xll.'? [A-Z0-9]+  `('                                                                                                                                                                       & 4        & MyFunction(        \\
VERTICAL\_RANGE        & Range of columns                                                                                                        & `\$'? [A-Z]+ ":" `\$'? {[}A-Z{]}+                                                                                                                                                                   & 0        & A:Z                \\ \bottomrule
\end{tabular}
\end{table*}

\subsection{Production rules}

We define our production rules in Extended BNF syntax. The start symbol is $Start$.

\begin{grammar}
<Start> ::= '=' Formula | ArrayFormula


%<Error> ::= "ERROR"
%
%<String> ::= "STRING"
%
%<QuotedFileSheet> ::= "QUOTED_FILESHEET"
%
%<Sheet> ::= "SHEET"
%
%<MultipleSheets> ::= "MULTIPLE_SHEETS"

<Cell> ::= "CELL"
	  \alt CellReferenceFunction

%<File> ::= "FILE"

<NamedRange> ::= "NAMED_RANGE"
            \alt "NAMED_RANGE_PREFIXED"

<Prefix> ::= "SHEET"
	\alt "FILE" "SHEET"
	\alt "FILE" `!'
	\alt "QUOTED_FILE_SHEET"
	\alt "MULTIPLE_SHEETS"
	\alt "FILE" "MULTIPLE_SHEETS"

<ReferenceItem> ::= Cell
	\alt "VERTICAL_RANGE"
	\alt "HORIZONTAL_RANGE"
	\alt NamedRange
	\alt "ERROR" 

<Reference> ::= ReferenceItem
	\alt Reference `:' Reference
	\alt Reference ` ' Reference
	\alt `(' Reference `)'
	\alt Prefix ReferenceItem
              \alt Prefix + "UDF" + Arguments + `)'
              
<Formula> ::= Reference
         \alt "NUMBER"
         \alt "STRING"
         \alt FunctionCall
         \alt "BOOL"
         \alt "RESERVED_NAME"

<Argument> ::= Formula
\alt ArrayAsArgument
\alt $\epsilon$

<Arguments> ::= Argument
\alt Argument `,' Arguments

<ArrayAsArgument> ::= `(' Arguments `)'

<Function> ::= "FUNCTION"
	\alt "UDF"

<FunctionCall> ::= Function Arguments `)'
\alt "UNOP_PREFIX" Formula
\alt Formula "UNOP_POSTFIX"
\alt Formula "BINOP" Formula
\alt `(' Formula `)'

<CellReferenceFunction> ::= "REFERENCE_FUNCTION" Arguments `)'

<ArrayFormula> ::= `\{=' ArrayArguments `\}' 

<ArrayArguments> ::= ArrayArgument
 \alt ArrayArgument `,' ArrayArguments
 \alt ArrayArgument `;' ArrayArguments
 
<ArrayArgument> ::= Formula
 \alt $\epsilon$


\end{grammar}

\subsection{Precedence and ambiguity}

All operators in Excel are left-associative, including the exponentiation operator. In order for our grammar to be unambiguous a separate operator precedence needs to be defined, which can be found in Table \ref{table:operatorprec}

\begin{table}
\label{table:operatorprec}
\caption{Operator precedence in Excel Formulas}
\begin{tabular}{lr}
Operator                                                                & Precedence \\
 & higher = greater \\
= \textless \textgreater \textless= \textgreater= \textless\textgreater & 1          \\
\&                                                                      & 2          \\
+ - (binary)                                                            & 3          \\
* /                                                                     & 4          \\
\textasciicircum                                                        & 5          \\
\%                                                                      & 6          \\
+ - (unary)                                                             & 7          \\
: whitespace                                                            & 8         
\end{tabular}
\end{table}

Putting the operator precedence directly into the grammar is relatively easy (and can be automated), but makes the grammar less clear and compact.

\subsection{Internationalization}

TODO: Move to discussion maybe?

The Excel grammar is different depending on the language of the software. For example function arguments are separated by a semicolon instead of a comma in countries that use the comma as a decimal separator.

Our grammar is only for the default (English) language setting. Grammars for other locales can be gotten by replacing delimiters and replacing the function list by the localized version.

It is worth noting that Excel will always save formulas in either a locale-independent binary format (Excel 2003 and earlier) or in its English version (Excel 2007 and later).

\subsection{Intersection operator}

TODO: Probably not worth its own section

The intersection binary operator in Excel formulas is a single whitespace.
The reset of the language is mostly whitespace independent.
Care must thus be taken on this point when parsing formulas.

If your parser supports implicit operators the intersection operator can be implemented this way.
An example of implicit operators outside of Excel is in mathematical formulas where multiplication is often ommitted, $5a$ is equivalent to $5 \cdot a$ thus making $\cdot$ an implied operator.


\section{Evaluation}
datasets, scantool

\section{Wacky Grammar}

References
- [1]!Hub\_Consolidation
- Functions returning references (INDEX|OFFSET|INDIRECT|???) SUM(A1:INDEX(A:A,1,1:1))
- External UDFs RIGHT([1]!SheetName(),(LEN([1]!SheetName())-20))
- Prefixed right limits =SUM(Deals!F9:'Deals'!F16)
- This thing we do not know what it is =BLP|M!'INDU Index,[PX\_close\_5d]'

Array formulas
- IF(OR(MONTH(GQ2) = {3,9}), IF(ABS(SUM(GQ223) - GQ225)>0.001,1,0), 0)

Arrays used as arguments
- LARGE((F38,C38),1)

Reserved names
- Add-in functions C9*\_xll.HEAT(B9,C9)
- \_xlnm.* =SUMIF('150000'!A:A,\_xlnm.Print\_Titles,'150000'!C:C)

Smelly grammar constructs + how often they are used
- Implicit intersect operator =COUNT(A1:A10Ë½A1:A5)
- Complex ranges =SUM(I8:namedRange:M8)
- Combinations of the above SUM((Total\_Cost Jan):(Total\_Cost Apr.))

\section{Discussion and Limitations}
Grammar for Excel version ???
Not covering array formulas (?)
QuotedContent / ContentInFile were left out, discuss

\section{Comparison against the LibreOffice grammar}

\section{Related work}

\section{Conclusion}
The conclusion goes here.




\section*{Acknowledgment}
The authors would like to thank...






%\bibliographystyle{IEEEtran}
% argument is your BibTeX string definitions and bibliography database(s)
%\bibliography{IEEEabrv,../bib/paper}
%
% <OR> manually copy in the resultant .bbl file
% set second argument of \begin to the number of references
% (used to reserve space for the reference number labels box)
\begin{thebibliography}{1}

\bibitem{IEEEhowto:kopka}
H.~Kopka and P.~W. Daly, \emph{A Guide to \LaTeX}, 3rd~ed.\hskip 1em plus
  0.5em minus 0.4em\relax Harlow, England: Addison-Wesley, 1999.

\end{thebibliography}


\end{document}


